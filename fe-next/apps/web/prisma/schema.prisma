
//  prismaç±»å‹é—®é¢˜ï¼š pnpx prisma generate --schema prisma/schema.prisma  



generator client {
  provider        = "prisma-client-js"
  // âœ¨ æ ¸å¿ƒç‰¹æ€§ï¼š
  // 1. postgresqlExtensions: å…è®¸åœ¨ schema é‡Œç®¡ç†æ’ä»¶
  // 2. typedSql: å…è®¸å†™åŸç”Ÿ SQL å¹¶ç”Ÿæˆ TS å‡½æ•°
  // 3. driverAdapters: å…è®¸åœ¨ Serverless ç¯å¢ƒä½¿ç”¨ HTTP/WS è¿æ¥
  previewFeatures = ["postgresqlExtensions", "typedSql"]
}

datasource db {
  provider   = "postgresql"
  extensions = [pgvector(map: "vector")]
}

// 1. èµ„æºè¡¨ (PDF/ç½‘é¡µ/æ–‡æ¡£)
model Resource {
  id       String  @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  content  String? @db.Text // åŸå§‹å…¨æ–‡(å¯é€‰ï¼Œå¤ªå¤§çš„è¯å¯ä»¥å­˜S3è·¯å¾„)
  fileName String // æ˜¾å¼å­˜æ–‡ä»¶åï¼Œæ–¹ä¾¿å±•ç¤º
  fileType String // pdf, md, txt

  // æ–‡ä»¶çº§å…ƒæ•°æ® (ä½œè€…ã€ä¸Šä¼ è€…ã€åŸå§‹URL)
  metadata Json?

  embeddings Embedding[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("resources")
}

// 2. å‘é‡åˆ‡ç‰‡è¡¨ (è®°å¿†å•å…ƒ)
model Embedding {
  id String @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid

  // --- æ ¸å¿ƒå†…å®¹ ---
  content String                      @db.Text
  vector  Unsupported("vector(1536)")

  // --- ç»“æ„åŒ–å…ƒæ•°æ® (ç”¨äºæ··åˆæ£€ç´¢ Hybrid Search) ---
  pageNumber Int? // ç¬¬å‡ é¡µ (PDFä¸“ç”¨)
  chunkIndex Int // åˆ‡ç‰‡åºå· (ç¬¬0å—, ç¬¬1å—...) -> ç”¨äºé‡ç»„ä¸Šä¸‹æ–‡

  // --- è¯­ä¹‰å…ƒæ•°æ® ---
  // æ ‡è¯†è¿™ä¸ªåˆ‡ç‰‡æ˜¯ä»€ä¹ˆï¼Ÿæ˜¯æ ‡é¢˜(Title)ï¼Ÿæ˜¯è¡¨æ ¼(Table)ï¼Ÿè¿˜æ˜¯æ­£æ–‡(Text)ï¼Ÿ
  // è¿™å¯¹â€œè§£æAgentâ€éå¸¸é‡è¦ï¼Œä¸åŒç±»å‹æƒé‡ä¸åŒã€‚
  category String @default("text")

  // --- åŸå§‹å¸ƒå±€ä¿¡æ¯ (Jsonb) ---
  // è¿™é‡Œå­˜ bbox (åæ ‡ [x,y,w,h])ï¼Œç”¨äºå‰ç«¯åœ¨PDFä¸Šé«˜äº®æ˜¾ç¤ºä½ç½®
  layoutInfo Json?

  // --- å…³è” ---
  resourceId String   @db.Uuid
  resource   Resource @relation(fields: [resourceId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  // --- ç´¢å¼•ä¼˜åŒ– ---
  // ä¸º resourceId å»ºç´¢å¼•ï¼Œæ–¹ä¾¿åˆ é™¤
  @@index([resourceId])
  // ä¸º chunks é¡ºåºå»ºç´¢å¼•ï¼Œæ–¹ä¾¿æŸ¥æ‰¾ä¸Šä¸‹æ–‡ (Previous/Next Chunk)
  @@index([resourceId, chunkIndex])
  @@map("embeddings")
}

// CREATE TABLE "resources" (
//   "id" UUID PRIMARY KEY DEFAULT gen_random_uuid(),
//   "content" TEXT,
//   "fileName" TEXT NOT NULL,
//   "fileType" TEXT NOT NULL,
//   "metadata" JSONB,
//   "createdAt" TIMESTAMP(3) NOT NULL DEFAULT CURRENT_TIMESTAMP,
//   "updatedAt" TIMESTAMP(3) NOT NULL
// );



// 1. ä»£ç ä»“åº“ (Git Repository)
model Repository {
  id          String        @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name        String        @unique // e.g. "SyncScribe-Web"
  description String?
  url         String?       // Github Link
  
  versions    CodeVersion[]

  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@map("repositories")
}

// 2. ä»£ç ç‰ˆæœ¬ (Git Commit / Tag)
model CodeVersion {
  id          String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  version     String     // e.g. "v1.0.0", "main", "sha-123456"
  
  repoId      String     @db.Uuid
  repo        Repository @relation(fields: [repoId], references: [id], onDelete: Cascade)
  
  files       CodeFile[] // ä¸€ä¸ªç‰ˆæœ¬åŒ…å«å¤šä¸ªæ–‡ä»¶

  createdAt   DateTime   @default(now())

  // æ ¸å¿ƒçº¦æŸï¼šåŒä¸€ä¸ªä»“åº“ä¸‹ï¼Œç‰ˆæœ¬å·å¿…é¡»å”¯ä¸€
  @@unique([repoId, version]) 
  @@map("code_versions")
}

// 3. ä»£ç æ–‡ä»¶ (Source File)
model CodeFile {
  id          String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  filePath    String      // e.g. "apps/web/lib/prisma.ts" (ç›¸å¯¹è·¯å¾„)
  language    String      // ts, py, go, rust
  
  versionId   String      @db.Uuid
  version     CodeVersion @relation(fields: [versionId], references: [id], onDelete: Cascade)
  
  chunks      CodeChunk[] // ä¸€ä¸ªæ–‡ä»¶åˆ‡æˆå¤šä¸ªå‡½æ•°/å—

  // æ ¸å¿ƒçº¦æŸï¼šåŒä¸€ä¸ªç‰ˆæœ¬ä¸‹ï¼Œæ–‡ä»¶è·¯å¾„å¿…é¡»å”¯ä¸€
  @@unique([versionId, filePath]) 
  @@map("code_files")
}

// 4. ä»£ç åˆ‡ç‰‡ (AST Chunk)
model CodeChunk {
  id          String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  content     String   @db.Text // ä»£ç å—å†…å®¹
  
  // âœ¨ å‘é‡å­—æ®µï¼šä»£ç ä¹Ÿéœ€è¦å‘é‡åŒ–
  vector      Unsupported("vector(1536)")
  
  // --- ä»£ç ä¸“ç”¨å…ƒæ•°æ® ---
  startLine   Int      // èµ·å§‹è¡Œå·
  endLine     Int      // ç»“æŸè¡Œå·
  
  // ä»£ç ç±»å‹ï¼š'function', 'class', 'method', 'import'
  // è¿™æ¯”æ–‡æ¡£çš„ 'text'/'table' æ›´å…³é”®ï¼Œå› ä¸ºæˆ‘ä»¬è¦æœ "ingestDocument å‡½æ•°"
  codeType    String   @default("block") 
  
  // ç¬¦å·åç§°ï¼šå‡½æ•°åã€ç±»å (e.g. "ingestDocument")
  // ğŸš¨ å…³é”®ï¼šè¿™æ˜¯æ··åˆæ£€ç´¢çš„å‘½é—¨ï¼ç”¨æˆ·æœå‡½æ•°åæ—¶ï¼Œæˆ‘ä»¬ç”¨ SQL ILIKE åŒ¹é…è¿™ä¸ªå­—æ®µ
  // ç¬¦å·åç§°ï¼Œä¾‹å¦‚å‡½æ•°åã€ç±»åã€‚ç”¨äºæ··åˆæ£€ç´¢æ—¶é€šè¿‡ SQL ILIKE åŒ¹é…ã€‚
  symbolName  String? 

  fileId      String   @db.Uuid
  file        CodeFile @relation(fields: [fileId], references: [id], onDelete: Cascade)

  createdAt   DateTime @default(now())

  // ç´¢å¼•ä¼˜åŒ–
  @@index([fileId])
  // æ”¯æŒæŒ‰ç¬¦å·åå¿«é€ŸæŸ¥æ‰¾ (e.g. æ‰¾æ‰€æœ‰å« "User" çš„ç±»)
  @@index([symbolName]) 

  @@map("code_chunks")
}

enum GamePhase {
  NIGHT_WOLF
  DAY_DISCUSS
}

enum PlayerRole {
  WOLF
  VILLAGER
  SEER
  WITCH
}

model Game {
  id              String       @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  round           Int          @default(1)
  phase           GamePhase    @default(NIGHT_WOLF)
  nextPlayerIndex Int          @default(0)
  status          String       @default("ONGOING")

  players         GamePlayer[]
  logs            GameLog[]

  createdAt       DateTime     @default(now())
  updatedAt       DateTime     @updatedAt
}

model GamePlayer {
  id        String     @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  gameId    String     @db.Uuid
  game      Game       @relation(fields: [gameId], references: [id], onDelete: Cascade)

  seat      Int
  name      String
  role      PlayerRole
  isAlive   Boolean    @default(true)
  modelName String
  memory    Json?

  logs      GameLog[]

  createdAt DateTime   @default(now())
  updatedAt DateTime   @updatedAt

  @@index([gameId])
  @@unique([gameId, seat])
}

model GameLog {
  id        String      @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  gameId    String      @db.Uuid
  game      Game        @relation(fields: [gameId], references: [id], onDelete: Cascade)

  playerId  String?     @db.Uuid
  player    GamePlayer? @relation(fields: [playerId], references: [id], onDelete: SetNull)

  round     Int
  phase     GamePhase
  thought   String?
  speech    String?
  action    Json

  createdAt DateTime    @default(now())

  @@index([gameId])
  @@index([playerId])
}
